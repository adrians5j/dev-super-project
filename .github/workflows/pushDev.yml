name: Dev Branch - Push

on:
  push:
    branches: [dev]

# Ensures only one deployment to "staging" environment can be in progress at the same time.
concurrency: dev_environment

jobs:
  # This first step ensures we don't run the workflow if the repository is empty.
  # Feel free to remove this step once your project is pushed to the repository.
  repository-check:
    name: Check if repository is empty
    runs-on: ubuntu-latest
    outputs:
      ready: ${{ steps.webiny-project-js.outputs.ready }}
    steps:
      - uses: actions/checkout@v2

      - name: Check if "webiny.project.js" exists
        id: webiny-project-js
        run: echo "::set-output name=ready::${{ hashFiles('webiny.project.ts') != '' }}"

  build-test-deploy:
    name: Build and test
    needs: repository-check
    runs-on: ubuntu-latest
    if: needs.repository-check.outputs.ready == 'true'
    environment: dev
    env:
      NODE_OPTIONS: --max_old_space_size=4096
      AWS_ACCESS_KEY_ID: ${{ secrets.DEV_AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}
      PULUMI_SECRETS_PROVIDER: ${{ secrets.DEV_PULUMI_SECRETS_PROVIDER }}
      PULUMI_CONFIG_PASSPHRASE: ${{ secrets.DEV_PULUMI_CONFIG_PASSPHRASE }}
      WEBINY_PULUMI_BACKEND: ${{ secrets.DEV_WEBINY_PULUMI_BACKEND }}
    steps:
      - uses: actions/setup-node@v2
        with:
          node-version: 12

      - name: Display the environment variables and their values
        run: |
          print %ENV
        shell: perl {0}

      - uses: actions/checkout@v2

      # 1. Install and cache dependencies.
      - uses: actions/cache@v2
        id: yarn-cache
        with:
          path: .yarn/cache
          key: yarn-${{ hashFiles('**/yarn.lock') }}


      - name: Install dependencies
        run: yarn --immutable

      # 2. Run static code analysis.
#      - name: Check code formatting
#        run: yarn prettier:check
#
#      - name: ESLint
#        run: yarn eslint

      # 3. Build custom packages (all packages located within the "packages" folder).
      - name: Build packages
        run: yarn webiny workspaces run build --folder packages

      # 4. Run tests.
#      - name: Run tests
#        run: yarn test

      # 5. Deploy to "dev" environment. Note that we do not deploy if the WEBINY_PULUMI_BACKEND
      # variable is missing. We want to have a single central storage of our cloud infrastructure
      # state files, for example an Amazon S3 bucket or Pulumi Service.
      # https://www.webiny.com/docs/how-to-guides/development/workflows/cloud-infrastructure-state-files
      - name: Deploy
        if: env.WEBINY_PULUMI_BACKEND
        run: yarn webiny deploy --env dev

      # Add additional steps if needed. For example, if you have additional E2E
      # tests done with Cypress (https://www.cypress.io/), you can run them here.
